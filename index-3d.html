<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>COOL RATIO</title>
<meta name="theme-color" content="#F6D35B"/>
<style>
  :root{
    --paper:#F6D35B; --ink:#0D0D0D; --orange:#FF7A00; --glow:#FFC066;
    --bg:var(--paper); --fg:var(--ink);
    --card:#fff6da; --tick:#00000025;
    --shadow:0 2px 10px rgba(0,0,0,.12), 0 8px 24px rgba(0,0,0,.08);
    --ring:0 0 0 2px color-mix(in oklab, var(--orange) 60%, transparent);
  }
  [data-theme="dark"]{ --bg:#0B0B0B; --fg:#F5F5F5; --card:#141414; --tick:#FFFFFF25; }
  [data-theme="paper"]{ --bg:#FFF6D6; --fg:#0D0D0D; --card:#FFFBEA; --tick:#00000022; }

  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--fg);
    font:600 16px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility; overflow:hidden;
  }

  /* Top bar */
  header{
    position:fixed; inset:0 0 auto 0; height:64px; z-index:20;
    display:grid; grid-template-columns:1fr minmax(220px,520px) 1fr; gap:8px; align-items:center;
    padding:8px 12px env(safe-area-inset-left) 8px env(safe-area-inset-right);
    background:linear-gradient(to bottom, color-mix(in oklab, var(--bg) 70%, transparent), transparent 60%);
    backdrop-filter:saturate(1.1) blur(6px);
  }
  .left,.center,.right{display:flex;align-items:center;gap:10px;min-width:0}
  .left{justify-content:flex-start}.center{justify-content:center}.right{justify-content:flex-end}
  .mark{display:inline-flex;align-items:center;gap:8px;color:var(--fg);text-decoration:none}
  .mark svg{width:132px;height:auto;display:block}
  .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}

  /* Tuner */
  .tuner{position:relative; flex:1; max-width:520px; height:40px; border-radius:999px;
    background: color-mix(in oklab, var(--card) 80%, transparent);
    box-shadow: inset 0 0 0 1px color-mix(in oklab, var(--fg) 10%, transparent);
  }
  .tuner .ticks{position:absolute; inset:8px 14px; pointer-events:none;
    background:linear-gradient(to right, var(--tick) 0 1px, transparent 1px 12.5%) repeat-x;
    background-size:12.5% 1px;
  }
  .tuner input[type="range"]{appearance:none; -webkit-appearance:none; position:absolute; inset:0; width:100%; height:100%; background:transparent; margin:0}
  .tuner input::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:18px;height:18px;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, var(--glow), var(--orange) 60%, #0000 61%);
    box-shadow:0 0 0 2px color-mix(in oklab, var(--orange) 65%, #0000), 0 4px 12px color-mix(in oklab, var(--orange) 35%, #0000);
    border:none;margin-top:0;
  }
  .tag-label{position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:12px;letter-spacing:.06em;text-transform:uppercase;opacity:.9}
  .control{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
    background:color-mix(in oklab,var(--card) 90%,transparent); box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--fg) 10%,transparent)}
  .btn{cursor:pointer;user-select:none;border:none;background:color-mix(in oklab,var(--card) 92%,transparent);
    color:var(--fg);padding:8px 12px;border-radius:999px;font-weight:800; box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--fg) 10%,transparent)}
  .switch{display:inline-flex;align-items:center;gap:6px;cursor:pointer;padding:6px 10px;border-radius:999px;
    background:color-mix(in oklab,var(--card) 90%,transparent); box-shadow:inset 0 0 0 1px color-mix(in oklab,var(--fg) 10%,transparent)}
  .switch input{display:none}
  .dot{width:16px;height:16px;border-radius:50%;background:radial-gradient(circle at 30% 30%, var(--glow), var(--orange))}
  .switch[data-off="true"] .dot{filter:grayscale(.9) brightness(.85);opacity:.55;box-shadow:none}

  main{position:fixed; inset:64px 0 0 0; overflow:hidden}

  /* Containers default hidden; we toggle via .show to avoid "elements stacked" */
  #shelf,#fallback,.state{display:none}
  #shelf.show{display:block}
  #fallback.show{display:grid}
  .state.show{display:grid}

  /* Shelf lanes (CSS 3D look) */
  #shelf{position:absolute; inset:0; perspective:1200px; perspective-origin:50% 40%;
    background:radial-gradient(1200px 600px at 50% 0%, color-mix(in oklab, var(--glow) 12%, transparent), transparent 60%);
  }
  .lane{position:absolute; left:0; width:100%; height:220px; transform-style:preserve-3d}
  .lane:nth-child(1){ top:18px; transform:translateZ(-140px) rotateX(6deg) }
  .lane:nth-child(2){ top:248px; transform:translateZ(-60px) rotateX(4deg) }
  .lane:nth-child(3){ top:478px; transform:translateZ(0) }
  .lane:nth-child(4){ top:708px; transform:translateZ(40px) rotateX(-2deg) }

  .tile{position:absolute; top:10px; width:160px; height:160px; border-radius:18px; background:var(--card);
    box-shadow:var(--shadow); display:flex; align-items:flex-end; justify-content:flex-start; padding:10px; outline:none}
  .tile .label{z-index:1;display:flex;flex-direction:column;gap:4px}
  .title{font-weight:900;font-size:14px}.tag{font-weight:700;font-size:11px;letter-spacing:.08em;text-transform:uppercase;opacity:.8}
  .seg{position:absolute;inset:auto 10px 10px auto;width:36px;height:36px;border-radius:10px;background:color-mix(in oklab,var(--orange) 18%,transparent);display:grid;place-items:center}
  .seg svg{width:22px;height:22px}

  /* Peek */
  .peek{position:fixed;bottom:16px;left:50%;transform:translate(-50%,140%);min-width:min(92vw,560px);border-radius:20px;
    background:var(--card);color:var(--fg);box-shadow:0 16px 60px rgba(0,0,0,.25);padding:14px 16px;display:flex;gap:14px;align-items:center;justify-content:space-between;z-index:30;transition:transform .18s ease}
  .peek.show{transform:translate(-50%,0)}
  .open{background:var(--orange);color:black;box-shadow:0 6px 20px color-mix(in oklab,var(--orange) 50%, transparent)}

  /* Fallback grid */
  #fallback{gap:12px; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); padding:16px; position:absolute; inset:0; overflow:auto}
  .fcard{border-radius:18px;padding:12px;background:var(--card);box-shadow:var(--shadow)}

  /* States */
  .state{position:absolute; inset:0; place-items:center; text-align:center; padding:24px; z-index:10}
  .skeleton{height:8px;border-radius:4px;background:linear-gradient(90deg,#0000,#00000010 50%,#0000);animation:shine 1.2s linear infinite}
  @keyframes shine{from{background-position:-200% 0}to{background-position:200% 0}}

  #scroll{position:absolute; inset:0; overflow:hidden}
  :focus-visible{ box-shadow:var(--ring)!important }
  @media (max-width:420px){ .tile{width:140px;height:140px} .lane{height:200px} }
</style>
</head>
<body>
<header role="banner" aria-label="Top bar">
  <div class="left">
    <a class="mark" href="#" aria-label="COOL RATIO home">
      <svg viewBox="0 0 640 120" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="var(--orange)"/><stop offset="1" stop-color="var(--glow)"/></linearGradient></defs>
        <g fill="currentColor"><text x="0" y="82" font-family="system-ui,Segoe UI,Arial" font-weight="900" font-size="86" letter-spacing="1">COOL</text>
          <text x="310" y="82" font-family="system-ui,Segoe UI,Arial" font-weight="900" font-size="86" letter-spacing="1">RATIO</text></g>
        <circle cx="280" cy="26" r="8" fill="url(#g)"/><rect x="270" y="40" width="20" height="3" rx="1.5" fill="currentColor" opacity=".4"/>
        <rect x="270" y="48" width="20" height="3" rx="1.5" fill="currentColor" opacity=".3"/><rect x="270" y="56" width="20" height="3" rx="1.5" fill="currentColor" opacity=".2"/>
      </svg>
    </a>
  </div>
  <div class="center">
    <div class="tuner" aria-label="Tag tuner">
      <div class="tag-label" id="tagLabel">all</div>
      <div class="ticks"></div>
      <input id="tuner" type="range" min="0" max="7" step="1" value="0" aria-labelledby="tagLabel"/>
    </div>
  </div>
  <div class="right">
    <div class="control" role="search"><span class="sr-only" id="searchLabel">Search projects</span>
      <input id="search" type="search" placeholder="Search" aria-labelledby="searchLabel" inputmode="search"/></div>
    <label class="switch" id="themeSwitch" aria-label="Theme"><input type="checkbox"/><div class="dot" aria-hidden="true"></div><span style="font-size:12px;letter-spacing:.06em">Theme</span></label>
    <label class="switch" id="hapticSwitch" aria-label="Haptics"><input type="checkbox"/><div class="dot" aria-hidden="true"></div><span style="font-size:12px;letter-spacing:.06em">Haptics</span></label>
  </div>
</header>

<main role="main" aria-live="polite" aria-busy="false">
  <div id="scroll" aria-label="Crate shelf">
    <div id="shelf">
      <div class="lane" data-lane="0"></div>
      <div class="lane" data-lane="1"></div>
      <div class="lane" data-lane="2"></div>
      <div class="lane" data-lane="3"></div>
    </div>
    <div id="fallback"></div>

    <!-- STATES (only one gets .show at a time) -->
    <div class="state" id="emptyState">
      <div>
        <div style="font-weight:900;font-size:28px;margin-bottom:10px">COOL RATIO</div>
        <div style="opacity:.8;margin-bottom:14px">Bright orange shelf. Pocket radio vibes.</div>
        <button class="btn" id="loadBtn">Load projects</button>
      </div>
    </div>

    <div class="state" id="errorState" role="alert">
      <div>
        <div style="font-weight:900;font-size:24px;margin-bottom:10px">Error loading</div>
        <div class="skeleton" style="width:220px;margin:8px auto"></div>
        <button class="btn" id="retryBtn">Retry</button>
      </div>
    </div>
  </div>

  <div class="peek" id="peek" role="dialog" aria-modal="false" aria-live="polite" aria-hidden="true">
    <div class="meta">
      <div class="t" id="peekTitle" style="font-weight:900">Title</div>
      <div class="g" id="peekTag" style="font-size:12px;opacity:.8;letter-spacing:.06em;text-transform:uppercase">Tag</div>
    </div>
    <div class="actions">
      <a class="btn" id="peekCopy" href="#">Copy link</a>
      <a class="btn open" id="peekOpen" href="#" target="_blank" rel="noopener">Open</a>
    </div>
  </div>
  <div class="sr-only" aria-live="polite" id="live"></div>
</main>

<noscript>
  <style>
    main{overflow:auto} #scroll{position:static} #fallback{display:grid !important}
    #emptyState,#errorState{display:none !important}
  </style>
  <div id="fallback" class="grid" style="padding-top:72px">
    <article class="fcard"><a href="https://example.com/oa">Orange Assemblies</a><div style="opacity:.7;font-size:12px">design</div></article>
    <article class="fcard"><a href="https://example.com/plat">Plat Sequencer</a><div style="opacity:.7;font-size:12px">audio</div></article>
  </div>
</noscript>

<script>
/* -------------------------
   DATA (inline)
------------------------- */
const PROJECTS = [
  { title:"Orange Assemblies", url:"https://example.com/oa",   tag:"design", color:"#FF7A00" },
  { title:"Plat Sequencer",    url:"https://example.com/plat", tag:"audio" },
  { title:"Ethereal Fugue",    url:"https://example.com/fugue",tag:"audio", color:"#FF9A3A" },
  { title:"Cool Ratio Demo",   url:"https://example.com/cool", tag:"system" },
  { title:"Pocket Radio UI",   url:"https://example.com/radio",tag:"design", color:"#FF7A00" },
  { title:"Crate Engine",      url:"https://example.com/crate",tag:"engine" },
  { title:"Segment Icons",     url:"https://example.com/seg",  tag:"design" },
  { title:"Nova Plat",         url:"https://example.com/nova", tag:"audio" },
  { title:"Orange Shelf",      url:"https://example.com/shelf",tag:"system", color:"#FF7A00" }
];

/* -------------------------
   Shorthands & Prefs
------------------------- */
const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const live = $('#live');
const prefersReduced = matchMedia('(prefers-reduced-motion: reduce)').matches;
const supportsVibrate = 'vibrate' in navigator;
const hasWebGL = (()=>{try{const c=document.createElement('canvas');return !!(c.getContext('webgl')||c.getContext('experimental-webgl'));}catch{ return false }})();
const prefs = {
  theme: localStorage.getItem('cr_theme') || 'auto',
  hapticsOn: JSON.parse(localStorage.getItem('cr_haptics') ?? (supportsVibrate && !prefersReduced)),
  lastFilter: localStorage.getItem('cr_filter') || 'all',
  search: ''
};
const setTheme = (mode)=>{
  let t = mode;
  if(mode==='auto') t = (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'paper');
  document.documentElement.setAttribute('data-theme', t);
  localStorage.setItem('cr_theme', mode);
  document.querySelector('meta[name="theme-color"]')?.setAttribute('content', getComputedStyle(document.documentElement).getPropertyValue('--bg').trim());
};

/* -------------------------
   Elements
------------------------- */
const scroll = $('#scroll'), shelf = $('#shelf'), lanes = $$('.lane'), fallback = $('#fallback');
const emptyState = $('#emptyState'), errorState = $('#errorState');
const peek = $('#peek'), peekTitle = $('#peekTitle'), peekTag = $('#peekTag'), peekOpen = $('#peekOpen'), peekCopy = $('#peekCopy');
const tuner = $('#tuner'), tagLabel = $('#tagLabel'), searchInput = $('#search');
const themeSwitch = $('#themeSwitch'), hapticSwitch = $('#hapticSwitch'), loadBtn = $('#loadBtn'), retryBtn = $('#retryBtn');

/* -------------------------
   ONE-STATE MACHINE (fixes "stacked states")
------------------------- */
function setView(view){
  // hide all
  shelf.classList.remove('show'); fallback.classList.remove('show');
  emptyState.classList.remove('show'); errorState.classList.remove('show');
  if(view==='empty') emptyState.classList.add('show');
  if(view==='error') errorState.classList.add('show');
  if(view==='shelf') shelf.classList.add('show');
  if(view==='fallback') fallback.classList.add('show');
}

/* -------------------------
   Tags / Tuner
------------------------- */
const TAGS = (()=>{ const base=['all']; const t=[...new Set(PROJECTS.map(p=>p.tag||'untagged'))].sort(); return base.concat(t).slice(0,8) })();
tuner.max = String(Math.max(0, TAGS.length-1));
const setTunerToTag = (t)=>{ const i=Math.max(0,TAGS.indexOf(t)); tuner.value=String(i); tagLabel.textContent=TAGS[i]||'all'; };
setTunerToTag(prefs.lastFilter||'all');

/* -------------------------
   Haptics
------------------------- */
const vibe = ms => { if (prefs.hapticsOn && supportsVibrate) try{navigator.vibrate(ms)}catch{} };

/* -------------------------
   Data filter
------------------------- */
const state = { items: PROJECTS.slice(), filterTag: prefs.lastFilter||'all', search:'' };
const byFilter = ()=>{
  const tag = state.filterTag, q = state.search.trim().toLowerCase();
  return state.items.filter(p=>{
    const tagOk = (tag==='all') || ((p.tag||'untagged')===tag);
    const qOk = !q || p.title.toLowerCase().includes(q) || (p.tag||'').toLowerCase().includes(q);
    return tagOk && qOk;
  });
};

/* -------------------------
   Shelf virtualization (CSS 3D)
------------------------- */
let W=0,H=0,worldX=0,velocity=0,dragging=false,dragStartX=0,worldStartX=0,raf=0;
const TILE_W=160,TILE_GAP=24,TILE_STEP=TILE_W+TILE_GAP,LANE_COUNT=lanes.length;
const tilesByLane = lanes.map(()=>new Map()); const pool=[];
const getTile = ()=> pool.pop() || createTile();

function createTile(){
  const el=document.createElement('button'); el.className='tile'; el.type='button';
  el.innerHTML=`<div class="label"><div class="title"></div><div class="tag"></div></div>
                <div class="seg" aria-hidden="true">${segmentIcon()}</div>`;
  el.addEventListener('pointerdown',tileDown); el.addEventListener('pointerup',tileUp);
  el.addEventListener('pointercancel',tileCancel); el.addEventListener('keydown',tileKey);
  return el;
}
function segmentIcon(){return `<svg viewBox="0 0 24 24" role="img" aria-label="segment icon">
  <path d="M12 2a10 10 0 1 1-7.07 2.93L12 12z" fill="currentColor" opacity=".1"></path>
  <circle cx="12" cy="12" r="2.5" fill="currentColor" opacity=".35"></circle>
  <path d="M12 12V2a10 10 0 0 1 10 10z" fill="currentColor" opacity=".2"></path>
</svg>`}
let longPressT=null;
function tileDown(e){ if(e.pointerType==='mouse'&&e.button!==0) return; this.setPointerCapture(e.pointerId); const d=this._data;
  longPressT=setTimeout(()=>{ showPeek(d); vibe(30);},420); }
function tileUp(){ if(longPressT){clearTimeout(longPressT); longPressT=null} if(Math.abs(velocity)<0.15){ const d=this._data; if(d?.url){vibe(10);window.open(d.url,'_blank','noopener'); announce(`Open ${d.title}`)}}}
function tileCancel(){ if(longPressT){clearTimeout(longPressT); longPressT=null}}
function tileKey(e){const el=this,l=+el.dataset.lane,c=+el.dataset.col;
  if(e.key==='Enter'){const d=el._data;if(d?.url){window.open(d.url,'_blank','noopener');vibe(10)}}
  else if(e.key==='Escape'){hidePeek()}
  else if(e.key==='ArrowRight'){focusTile(l,c+1)}
  else if(e.key==='ArrowLeft'){focusTile(l,Math.max(0,c-1))}
  else if(e.key==='ArrowUp'){focusTile(Math.max(0,l-1),c)}
  else if(e.key==='ArrowDown'){focusTile(Math.min(LANE_COUNT-1,l+1),c)}
}
function focusTile(l,c){const m=tilesByLane[l],t=m.get(c); if(t) t.focus()}

function ensureRAF(){ if(!raf) raf=requestAnimationFrame(tick) }
function stopRAF(){ if(raf){cancelAnimationFrame(raf); raf=0} }

function tick(){ raf=0; if(!dragging){ velocity*=0.95; if(Math.abs(velocity)<0.01) velocity=0; worldX+=velocity }
  layout(); if(dragging||Math.abs(velocity)>0.001) ensureRAF(); }

function layout(){
  const items=byFilter(); if(!items.length){ lanes.forEach(l=>l.replaceChildren()); return }
  const columnsVisible = Math.ceil(W/TILE_STEP)+2; const startCol = Math.floor((-worldX)/TILE_STEP)-1;
  for(let li=0; li<LANE_COUNT; li++){
    const lane=lanes[li], map=tilesByLane[li], need=new Set();
    for(let c=startCol; c<startCol+columnsVisible; c++){
      if(c<0) continue; const item=items[(c)%items.length]; if(!item) continue; need.add(c);
      let el=map.get(c); if(!el){ el=getTile(); el.dataset.lane=String(li); el.dataset.col=String(c); lane.append(el); map.set(c,el); }
      if(el._data!==item){ el._data=item; el.setAttribute('aria-label',`${item.title}${item.tag?', '+item.tag:''}`);
        el.querySelector('.title').textContent=item.title; el.querySelector('.tag').textContent=item.tag||'untagged';
        const color=item.color||getComputedStyle(document.documentElement).getPropertyValue('--orange').trim();
        el.style.background=`linear-gradient(180deg, ${lighten(color,.25)} 0%, var(--card) 90%)`; }
      const x=c*TILE_STEP+worldX+24; el.style.left=x+'px'; const tilt=Math.max(-6,Math.min(6,(x-W/2)*0.01)); el.style.transform=`translateZ(0) rotateY(${tilt}deg)`;
    }
    for(const [c,el] of map.entries()){ if(!need.has(c)){ el.remove(); map.delete(c); pool.push(el) } }
  }
}
function lighten(hex,amt){const c=hex.replace('#','');const r=parseInt(c.slice(0,2),16),g=parseInt(c.slice(2,4),16),b=parseInt(c.slice(4,6),16);
  const L=t=>Math.round(t+(255-t)*amt); return `rgb(${L(r)} ${L(g)} ${L(b)})`;}

/* Drag/Flick */
scroll.addEventListener('pointerdown',e=>{ if(e.button!==0) return; dragging=true; dragStartX=e.clientX; worldStartX=worldX; velocity=0; scroll.setPointerCapture(e.pointerId); ensureRAF(); });
scroll.addEventListener('pointermove',e=>{ if(!dragging) return; const dx=e.clientX-dragStartX; worldX=worldStartX+dx; velocity=dx*0.12; });
scroll.addEventListener('pointerup',()=>{ dragging=false; vibe(4); ensureRAF() });
scroll.addEventListener('pointercancel',()=>{ dragging=false });

/* Peek */
function showPeek(item){ peekTitle.textContent=item.title; peekTag.textContent=item.tag||'untagged'; peekOpen.href=item.url||'#'; peekCopy.href='#'; peek.classList.add('show'); peek.setAttribute('aria-hidden','false'); }
function hidePeek(){ peek.classList.remove('show'); peek.setAttribute('aria-hidden','true'); }
peekCopy.addEventListener('click',e=>{ e.preventDefault(); const url=peekOpen.href; navigator.clipboard?.writeText(url); announce('Link copied'); vibe(10); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') hidePeek() });
document.addEventListener('pointerdown',e=>{ if(!peek.contains(e.target)) hidePeek() });

/* Search / Tuner / Toggles */
let searchT=0;
searchInput.addEventListener('input',()=>{ clearTimeout(searchT); const val=searchInput.value; searchT=setTimeout(()=>{ state.search=val; announce(val?`Search ${val}`:'Search cleared'); (currentMode==='fallback')?renderFallback():ensureRAF(); },120); });
tuner.addEventListener('input',()=>{ const idx=+tuner.value; const tag=TAGS[idx]; tagLabel.textContent=tag; state.filterTag=tag; localStorage.setItem('cr_filter',tag); (currentMode==='fallback')?renderFallback():ensureRAF(); });
themeSwitch.addEventListener('click',()=>{ const order=['auto','dark','paper']; const next=order[(order.indexOf(localStorage.getItem('cr_theme')||'auto')+1)%order.length]; setTheme(next); announce(`Theme ${next}`) });
hapticSwitch.addEventListener('click',()=>{ const off=hapticSwitch.getAttribute('data-off')==='true'; const next=!off; hapticSwitch.setAttribute('data-off',String(next)); prefs.hapticsOn=!next; localStorage.setItem('cr_haptics',JSON.stringify(prefs.hapticsOn)); announce(`Haptics ${prefs.hapticsOn?'on':'off'}`) });

/* A11y live */
function announce(msg){ live.textContent=''; setTimeout(()=>{ live.textContent=msg },10); }

/* Fallback render */
function renderFallback(){
  fallback.innerHTML='';
  const items=byFilter();
  if(!items.length){ const d=document.createElement('div'); d.style.opacity='.8'; d.textContent='No projects match.'; fallback.append(d); return; }
  for(const p of items){
    const el=document.createElement('article'); el.className='fcard';
    el.innerHTML=`<a href="${p.url}" target="_blank" rel="noopener">${p.title}</a><div style="opacity:.7;font-size:12px">${p.tag||'untagged'}</div>`;
    fallback.append(el);
  }
}

/* Mode selection */
let currentMode='empty';
function mount(){
  W=scroll.clientWidth; H=scroll.clientHeight;
  const forceFallback = prefersReduced || !hasWebGL;
  currentMode = forceFallback ? 'fallback' : 'shelf';
  if(currentMode==='fallback'){ renderFallback(); setView('fallback'); }
  else { setView('shelf'); ensureRAF(); }
}

/* States actions */
loadBtn?.addEventListener('click',()=>{ mount() });
retryBtn?.addEventListener('click',()=>{ mount() });

/* Init */
(function init(){
  setTheme(prefs.theme);
  hapticSwitch.setAttribute('data-off', String(!prefs.hapticsOn));
  setTunerToTag(prefs.lastFilter); state.filterTag=prefs.lastFilter;
  setView('empty'); // only EMPTY visible at start (fix for stacked states)
  addEventListener('resize',()=>{ W=scroll.clientWidth; H=scroll.clientHeight; (currentMode==='fallback')?renderFallback():ensureRAF(); }, {passive:true});
})();
window.COOL_RATIO={ add(p){PROJECTS.push(p); (currentMode==='fallback')?renderFallback():ensureRAF(); }, setTheme, setFilter(tag){ setTunerToTag(tag); state.filterTag=tag; (currentMode==='fallback')?renderFallback():ensureRAF(); } };
</script>
</body>
</html>
